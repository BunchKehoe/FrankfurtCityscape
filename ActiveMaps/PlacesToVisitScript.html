<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.js"></script>
<style>:root{--primary-red:#c00;--primary-green:#285c3a;--background-white:#fff;--shadow-light:rgba(0,0,0,0.1);--shadow-medium:rgba(0,0,0,0.15);--border-radius:8px;--spacing-xs:4px;--spacing-sm:8px;--spacing-md:12px;--spacing-lg:16px;--spacing-xl:24px;--font-family-primary:"Open Sans",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;--font-size-sm:0.875rem;--font-size-md:1rem;--font-size-lg:1.125rem;--line-height-normal:1.5;--transition-fast:0.2s ease}*{box-sizing:border-box}@import url("https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap");.map{width:100%;height:100%;border-radius:var(--border-radius);overflow:visible}.map-container{width:100%;height:700px;position:relative;border-radius:var(--border-radius);overflow:visible;box-shadow:0 4px 12px var(--shadow-medium)}.mapboxgl-popup{max-width:400px;font-family:var(--font-family-primary);font-size:var(--font-size-sm);line-height:var(--line-height-normal)}.mapboxgl-popup-content{padding:var(--spacing-md);border-radius:var(--border-radius)}.popup-content{text-align:center}.popup-title{font-weight:600;margin-bottom:var(--spacing-sm);color:#333}.popup-button{background:var(--primary-red);color:white;border:none;padding:var(--spacing-xs) var(--spacing-md);border-radius:var(--spacing-xs);font-size:var(--font-size-sm);font-weight:600;cursor:pointer;transition:background-color var(--transition-fast)}.popup-button:hover{background:#a00}.popup-button:disabled{background:#ccc;cursor:not-allowed}.popup-button:disabled:hover{background:#ccc}.popup-close{position:absolute;top:8px;right:8px;background:none;border:none;font-size:18px;cursor:pointer;color:#999;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all var(--transition-fast)}.popup-close:hover{background:#f0f0f0;color:#666}.legend{max-width:280px;width:45%;max-height:90%;overflow-y:auto;display:none;background-color:var(--background-white);border-radius:var(--border-radius);top:var(--spacing-lg);left:var(--spacing-lg);box-shadow:0 4px 12px var(--shadow-medium);font-family:var(--font-family-primary);font-size:var(--font-size-sm);line-height:var(--line-height-normal);padding:var(--spacing-lg);position:absolute;z-index:1000;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}.legend-mobile{background-color:var(--background-white);display:none;border-radius:var(--border-radius);box-shadow:0 2px 8px var(--shadow-light);font-family:var(--font-family-primary);font-size:var(--font-size-sm);line-height:var(--line-height-normal);padding:var(--spacing-lg);position:absolute;width:85%;max-height:70vh;overflow-y:auto;left:50%;top:60px;transform:translateX(-50%);z-index:9999;max-width:280px}.legend-toggle-btn{position:absolute;top:10px;left:10px;z-index:9000;background-color:white;border:none;border-radius:var(--border-radius);box-shadow:0 2px 6px var(--shadow-light);padding:8px 12px;font-size:var(--font-size-sm);font-weight:600;cursor:pointer;display:none}.legend-close-btn{position:absolute;top:10px;right:10px;background:none;border:none;font-size:18px;cursor:pointer;color:#666}.legend h4,.legend-mobile h4{margin:0 0 var(--spacing-md) 0;font-size:var(--font-size-lg);font-weight:700;color:#333;border-bottom:2px solid #f0f0f0;padding-bottom:var(--spacing-xs)}.legend-section{margin-bottom:var(--spacing-md)}.legend-section:last-child{margin-bottom:0}.legend-section h5{margin:0 0 var(--spacing-xs) 0;font-size:var(--font-size-sm);font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px}.legend-item{display:flex;align-items:center;margin-bottom:var(--spacing-xs);padding:2px 0;transition:all var(--transition-fast);cursor:pointer;border-radius:var(--spacing-xs)}.legend-item:hover{background-color:#f8f9fa;padding-left:var(--spacing-xs);padding-right:var(--spacing-xs)}.legend-item.active{background-color:#e3f2fd;padding-left:var(--spacing-xs);padding-right:var(--spacing-xs)}.legend-item.inactive{opacity:0.4;background-color:#f5f5f5;padding-left:var(--spacing-xs);padding-right:var(--spacing-xs)}.legend-item.inactive svg{opacity:0.5}.legend-item.inactive .color-indicator{opacity:0.5}.legend-item svg{margin-right:var(--spacing-sm);flex-shrink:0}.legend-item span.color-indicator{display:inline-block;width:15px;height:15px;margin-right:var(--spacing-sm);border-radius:2px;flex-shrink:0}.destination-type{font-weight:600;margin-bottom:2px}.destination-type.top{color:var(--primary-red)}.destination-type.worth{color:var(--primary-red);font-weight:400}.destination-type.special{color:#666;font-weight:300}.destination-type.natural{color:var(--primary-green);font-style:italic;font-weight:600}@media (max-width:991px){.map-container{height:70vh}.legend{max-width:220px;width:40%;padding:var(--spacing-md)}.map-container{border-radius:var(--spacing-xs)}}@media (max-width:576px){.legend{display:none!important}.legend-mobile{display:none}.legend-toggle-btn{display:block}.legend h4{font-size:var(--font-size-md)}}</style>
<div class="map-container">
<div id="map" class="map"></div>
<div id="legend" class="legend"></div>
<button id="legend-toggle" class="legend-toggle-btn">Show Legend</button>
<div id="legend-mobile" class="legend-mobile">
<button id="legend-close" class="legend-close-btn">×</button>
</div>
</div>
<script>
// ============================================================
// PlacesToVisitScript — Refactored 2026-02-19
// ============================================================

// --- Constants ---
const MAPBOX_TOKEN = "pk.eyJ1IjoiamNidW5jaDMiLCJhIjoiY2t6NzM0em9uMGlvbzMwbWdkbmR5N2loaCJ9.eKquRAbhpJDDshFFKtd9Yw";
const MAP_STYLE = "mapbox://styles/jcbunch3/cljssqa5h01ch01o4adoyhdlt";
const DEFAULT_CENTER = [8.8, 52.5];
const DEFAULT_ZOOM_DESKTOP = 5.1;
const DEFAULT_ZOOM_MOBILE = 4;
const DATASET_ID = "cmljrq0xj0pp11mpcywksh76c";
const USERNAME = "jcbunch3";

const SOURCES = {
  "places": "mapbox://jcbunch3.cmd6clxb92tlo1ns8ro5qgig8-0g7n5",
  "cultural-landscapes": "mapbox://jcbunch3.9b7pcnhy",
  "national-parks": "mapbox://jcbunch3.clkc6qkel2xr42aleuq3sjnsq-0zrfg",
  "railroads": "mapbox://jcbunch3.8o05xvpq",
  "vineyards": "mapbox://jcbunch3.86vjg7du",
  "mapbox-dem": "mapbox://mapbox.mapbox-terrain-dem-v1"
};

const DEFAULT_ACTIVE_FILTERS = [
  "city", "circle-sm", "square-sm", "monument", "museum", "crosshammer",
  "lookout-360", "religious-christian", "religious-jewish", "mountain", "food", "restaurant"
];

const RED_COLORS = ["#a10001", "#8f1b11", "#aa3524", "#9b0101", "#a43b2d"];

// --- Location Config (populated from dataset) ---
let locationConfig = {};
let isLocationConfigLoaded = false;

// Compute bounding box from GeoJSON polygon/multipolygon geometry
function computeBbox(geometry) {
  let minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
  const rings = geometry.type === "MultiPolygon"
    ? geometry.coordinates.flat()
    : geometry.coordinates;
  for (const ring of rings) {
    for (const [lng, lat] of ring) {
      if (lng < minLng) minLng = lng;
      if (lng > maxLng) maxLng = lng;
      if (lat < minLat) minLat = lat;
      if (lat > maxLat) maxLat = lat;
    }
  }
  return [[minLng, minLat], [maxLng, maxLat]];
}

// Load location configuration from Historical Regions dataset (paginated)
async function loadLocationConfig() {
  try {
    const limit = 100;
    let allFeatures = [];
    let startId = null;

    while (true) {
      let url = `https://api.mapbox.com/datasets/v1/${USERNAME}/${DATASET_ID}/features?limit=${limit}&access_token=${MAPBOX_TOKEN}`;
      if (startId) url += `&start=${startId}`;

      const response = await fetch(url);
      const data = await response.json();

      if (!data.features || data.features.length === 0) break;
      allFeatures = allFeatures.concat(data.features);

      // Note: Mapbox Datasets API may return fewer than `limit` even when more exist.
      // Only stop when we get an empty page.
      startId = data.features[data.features.length - 1].id;
    }

    allFeatures.forEach(feature => {
      const props = feature.properties;
      const geom = feature.geometry;

      if (props.url && geom && (geom.type === "Polygon" || geom.type === "MultiPolygon")) {
        const urlSlug = props.url.split("/").pop();
        if (urlSlug) {
          locationConfig[urlSlug] = computeBbox(geom);
        }
      }
    });

    isLocationConfigLoaded = true;
    console.log("Location config loaded:", Object.keys(locationConfig).length, "regions from dataset");
  } catch (error) {
    console.error("Failed to load location config:", error);
    isLocationConfigLoaded = true;
  }
}

// Match current URL pathname segments against location slugs (fixes partial-match bug)
function getLocationBbox() {
  const segments = window.location.pathname.split("/");
  for (const [slug, bbox] of Object.entries(locationConfig)) {
    if (segments.includes(slug)) {
      console.log("Matched location:", slug);
      return bbox;
    }
  }
  return null;
}

// --- Map Sources ---
function addSources(map) {
  Object.entries(SOURCES).forEach(([name, url]) => {
    if (name === "mapbox-dem") {
      map.addSource(name, { type: "raster-dem", url: url, tileSize: 512, maxzoom: 14 });
    } else {
      map.addSource(name, { type: "vector", url: url });
    }
  });
}

// --- Sky Layer (Feature 2) ---
function addSkyLayer(map) {
  map.addLayer({
    id: "sky",
    type: "sky",
    paint: {
      "sky-type": "atmosphere",
      "sky-atmosphere-sun": [0.0, 90.0],
      "sky-atmosphere-sun-intensity": 15
    }
  });
}

// --- Overlay Layers ---
function addOverlayLayers(map) {
  map.addLayer({
    id: "cultural-landscapes-fill",
    type: "fill",
    source: "cultural-landscapes",
    "source-layer": "Landscapes2-8zz5we",
    layout: { visibility: "none" },
    paint: { "fill-color": "#376da1", "fill-opacity": 0.5 }
  });

  map.addLayer({
    id: "cultural-landscapes-label",
    type: "symbol",
    source: "cultural-landscapes",
    "source-layer": "Landscapes2-8zz5we",
    layout: {
      visibility: "none",
      "text-field": ["get", "NAM"],
      "text-font": ["Open Sans Semibold Italic", "Arial Unicode MS Bold"],
      "text-size": 16,
      "text-anchor": "center",
      "text-allow-overlap": false
    },
    paint: {
      "text-color": "#376da1",
      "text-halo-color": "rgba(255, 255, 255, 0.8)",
      "text-opacity": 0.7,
      "text-halo-width": 1.5
    }
  });

  map.addLayer({
    id: "national-parks-fill",
    type: "fill",
    source: "national-parks",
    "source-layer": "EuropeNationalParks",
    layout: { visibility: "visible" },
    paint: { "fill-color": "#285c3a", "fill-opacity": 0.2 }
  });

  map.addLayer({
    id: "national-parks-label",
    type: "symbol",
    source: "national-parks",
    "source-layer": "EuropeNationalParks",
    layout: {
      visibility: "visible",
      "text-field": ["get", "NAM"],
      "text-font": ["Open Sans Semibold Italic", "Arial Unicode MS Bold"],
      "text-size": 16,
      "text-anchor": "center",
      "text-allow-overlap": false,
      "text-transform": "none"
    },
    paint: {
      "text-color": "#285c3a",
      "text-opacity": 0.7,
      "text-halo-color": "rgba(255, 255, 255, 0.8)",
      "text-halo-width": 1.5
    }
  });

  map.addLayer({
    id: "railroads",
    type: "line",
    source: "railroads",
    "source-layer": "EURailwaysComplete-cktonh",
    layout: { visibility: "visible" },
    paint: {
      "line-color": "#a87348",
      "line-opacity": 1,
      "line-width": 2,
      "line-dasharray": [2, 1]
    }
  });

  map.addLayer({
    id: "vineyards",
    type: "fill",
    source: "vineyards",
    "source-layer": "WineTest3-7cv5f4",
    layout: { visibility: "visible" },
    paint: { "fill-color": "#7e09a5", "fill-opacity": 0.4 }
  });
}

// --- Places Icon Layers ---
// Shared base layout for icon-image, icon-size, sort-key, text-font, text-size.
// Text positioning differs per layer, so it's applied in addPlacesLayers().
function getPlacesBaseLayout() {
  return {
    "icon-image": [
      "match", ["get", "marker-symbol"],
      "circle-sm", "town-hall",
      "religious-christian", "religious-christian",
      "religious-islam", "religious-islam",
      "religious-jewish", "religious-jewish",
      "monument", "monument",
      "museum", "museum",
      "square-sm", "castle",
      "city", "border-dot-13",
      "crosshammer", "industry",
      "home-2", "highway-rest-area",
      "home", "highway-rest-area",
      "lookout-360", "viewpoint",
      "food", "fast-food",
      "restaurant", "fast-food",
      "mountain", "mountain",
      "dot-11"
    ],
    "icon-size": 1.3,
    "icon-padding": 2,
    // Lower sort key = higher priority for collision placement.
    // Red entries and cities are placed first and win collisions.
    "symbol-sort-key": [
      "case",
      ["all", ["in", ["get", "marker-color"], ["literal", RED_COLORS]], ["==", ["get", "marker-symbol"], "city"]], 1,
      ["in", ["get", "marker-color"], ["literal", RED_COLORS]], 2,
      ["==", ["get", "marker-symbol"], "city"], 3,
      ["match", ["get", "marker-symbol"],
        ["circle-sm", "square-sm", "mountain"], 5,
        ["monument", "museum", "religious-christian", "religious-islam", "religious-jewish"], 7,
        10
      ]
    ],
    "text-field": ["get", "title"],
    "text-font": [
      "match", ["get", "marker-symbol"],
      ["crosshammer", "religious-christian", "monument", "square-sm", "museum", "circle-sm", "religious-islam"],
      ["literal", ["Open Sans Semibold", "Arial Unicode MS Regular"]],
      ["mountain", "food"],
      ["literal", ["Open Sans Bold Italic", "Arial Unicode MS Bold"]],
      "city",
      ["literal", ["Open Sans Extrabold", "Arial Unicode MS Bold"]],
      ["literal", ["Open Sans Semibold", "Arial Unicode MS Regular"]]
    ],
    "text-size": [
      "case",
      ["all", ["in", ["get", "marker-color"], ["literal", RED_COLORS]], ["==", ["get", "marker-symbol"], "city"]], 16,
      ["in", ["get", "marker-color"], ["literal", RED_COLORS]], 14,
      12
    ],
    "text-padding": 2
  };
}

function getPlacesPaint() {
  return {
    "text-color": [
      "match", ["get", "marker-color"],
      ["#005741", "#1e523d", "#1d6b53", "#005943"], "#377632",
      ["#000000", "#333333", "#7c0000"], "#000000",
      ["#a10001", "#8f1b11", "#aa3524", "#9b0101", "#a43b2d"], "#a10001",
      "#fe9900", "#fe9900",
      "#000000"
    ],
    "text-halo-color": "#ffffff",
    "text-halo-width": 1.5,
    "icon-opacity": 1,
    "text-opacity": 1
  };
}

function addPlacesLayers(map) {
  const baseLayout = getPlacesBaseLayout();
  const paint = getPlacesPaint();

  // Shared text positioning: dynamic via text-variable-anchor.
  // Requires text-allow-overlap: false. text-optional: true keeps icons visible
  // even when their label is hidden by collision.
  const dynamicTextProps = {
    "icon-allow-overlap": true,
    "icon-ignore-placement": true,
    "text-allow-overlap": false,
    "text-optional": true,
    "text-variable-anchor": ["top", "bottom", "left", "right", "top-left", "top-right", "bottom-left", "bottom-right"],
    "text-radial-offset": 1
  };

  // Layer 1 — Regional (non-red, non-city): rendered first (behind).
  const regionalLayout = Object.assign({}, baseLayout, dynamicTextProps);

  map.addLayer({
    id: "places-icons-regional",
    type: "symbol",
    source: "places",
    "source-layer": "PlacesToVisit6",
    minzoom: 0,
    maxzoom: 14,
    filter: [
      "all",
      ["!=", ["get", "zoom"], "city"],
      ["!", ["in", ["get", "marker-color"], ["literal", RED_COLORS]]]
    ],
    layout: regionalLayout,
    paint: paint
  });

  // Layer 2 — Priority (red, non-city): rendered second so red icons sit on top.
  // Same dynamic text positioning — NOT text-allow-overlap: true.
  const priorityLayout = Object.assign({}, baseLayout, dynamicTextProps);

  map.addLayer({
    id: "places-icons-priority",
    type: "symbol",
    source: "places",
    "source-layer": "PlacesToVisit6",
    minzoom: 0,
    maxzoom: 14,
    filter: [
      "all",
      ["!=", ["get", "zoom"], "city"],
      ["in", ["get", "marker-color"], ["literal", RED_COLORS]]
    ],
    layout: priorityLayout,
    paint: paint
  });

  // Layer 3 — City (city-zoom only): rendered on top of everything.
  const cityLayout = Object.assign({}, baseLayout, dynamicTextProps);

  map.addLayer({
    id: "places-icons-city",
    type: "symbol",
    source: "places",
    "source-layer": "PlacesToVisit6",
    minzoom: 12,
    maxzoom: 22,
    filter: ["==", ["get", "zoom"], "city"],
    layout: cityLayout,
    paint: paint
  });
}

// --- Map Controls ---
function addMapControls(map) {
  map.addControl(new mapboxgl.NavigationControl(), "top-right");
  map.addControl(new mapboxgl.FullscreenControl(), "top-right");
  map.addControl(new mapboxgl.GeolocateControl({
    positionOptions: { enableHighAccuracy: true },
    trackUserLocation: true,
    showUserHeading: true
  }), "top-right");
  map.addControl(new mapboxgl.ScaleControl({ maxWidth: 100, unit: "metric" }), "bottom-right");
}

// --- ARIA Labels (Feature 3: uses map.once('idle') instead of setTimeout) ---
function setupAriaLabels(map, legendSelector) {
  map.once("idle", () => {
    const ariaMap = {
      ".mapboxgl-ctrl-fullscreen": "Toggle fullscreen view",
      ".mapboxgl-ctrl-geolocate": "Find my location",
      ".mapboxgl-ctrl-zoom-in": "Zoom in",
      ".mapboxgl-ctrl-zoom-out": "Zoom out",
      ".mapboxgl-ctrl-compass": "Reset map rotation"
    };
    Object.entries(ariaMap).forEach(([sel, label]) => {
      const el = document.querySelector(sel);
      if (el) el.setAttribute("aria-label", label);
    });
    document.querySelectorAll(legendSelector + " .legend-item").forEach(item => {
      item.setAttribute("role", "button");
      item.setAttribute("tabindex", "0");
      item.addEventListener("keypress", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          item.click();
        }
      });
    });
  });
}

// --- Layer Toggle Helpers ---
function toggleLayerPair(map, fillId, labelId) {
  const currentVisibility = map.getLayoutProperty(fillId, "visibility");
  const newVisibility = currentVisibility === "visible" ? "none" : "visible";
  map.setLayoutProperty(fillId, "visibility", newVisibility);
  map.setLayoutProperty(labelId, "visibility", newVisibility);
  return newVisibility;
}

function toggleSingleLayer(map, layerId) {
  const currentVisibility = map.getLayoutProperty(layerId, "visibility");
  const newVisibility = currentVisibility === "visible" ? "none" : "visible";
  map.setLayoutProperty(layerId, "visibility", newVisibility);
  return newVisibility;
}

function createLayerToggle(map, filter) {
  const toggles = {
    "cultural-landscapes": () => toggleLayerPair(map, "cultural-landscapes-fill", "cultural-landscapes-label"),
    "national-parks": () => toggleLayerPair(map, "national-parks-fill", "national-parks-label"),
    "railroads": () => toggleSingleLayer(map, "railroads"),
    "vineyards": () => toggleSingleLayer(map, "vineyards")
  };
  return toggles[filter] || null;
}

// --- Places Filter ---
function applyPlacesFilter(map, filters) {
  if (filters.length === 0) {
    map.setFilter("places-icons-regional", ["==", "marker-symbol", "__none__"]);
    map.setFilter("places-icons-priority", ["==", "marker-symbol", "__none__"]);
  } else {
    map.setFilter("places-icons-regional", [
      "all",
      ["!=", ["get", "zoom"], "city"],
      ["!", ["in", ["get", "marker-color"], ["literal", RED_COLORS]]],
      ["match", ["get", "marker-symbol"], filters, true, false]
    ]);
    map.setFilter("places-icons-priority", [
      "all",
      ["!=", ["get", "zoom"], "city"],
      ["in", ["get", "marker-color"], ["literal", RED_COLORS]],
      ["match", ["get", "marker-symbol"], filters, true, false]
    ]);
  }
}

// --- Legend Filters (shared between mobile + desktop) ---
function setupLegendFilters(overlay, map, activeFilters) {
  const filterItems = overlay.querySelectorAll(".legend-item[data-filter]");
  filterItems.forEach(item => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      const filter = item.dataset.filter;
      const toggleFunc = createLayerToggle(map, filter);

      if (toggleFunc) {
        const newVisibility = toggleFunc();
        item.classList.toggle("active", newVisibility === "visible");
        item.classList.toggle("inactive", newVisibility === "none");
      } else {
        if (activeFilters.has(filter)) {
          activeFilters.delete(filter);
          item.classList.remove("active");
          item.classList.add("inactive");
        } else {
          activeFilters.add(filter);
          item.classList.remove("inactive");
          item.classList.add("active");
        }
        applyPlacesFilter(map, Array.from(activeFilters));
      }
    });
  });
}

// --- Legend HTML ---
function getLegend() {
  return '<h4>Map Legend</h4><div class="legend-section"><h5>Places by Importance</h5><div class="legend-item"><div class="destination-type top">Top Destinations</div></div><div class="legend-item"><div class="destination-type worth">Worth a Visit</div></div><div class="legend-item"><div class="destination-type special">Special Interest</div></div><div class="legend-item"><div class="destination-type natural">Beautiful Landscape</div></div></div><div class="legend-section"><h5>Location Types</h5><div class="legend-item active" data-filter="city"><svg width="15" height="15" viewBox="0 0 15 15" xmlns="http://www.w3.org/2000/svg"><path d="M7.5 12.3C4.84898 12.3 2.7 10.151 2.7 7.5C2.7 4.84898 4.84898 2.7 7.5 2.7C10.151 2.7 12.3 4.84898 12.3 7.5C12.3 10.151 10.151 12.3 7.5 12.3ZM7.5 14C11.0899 14 14 11.0899 14 7.5C14 3.9101 11.0899 1 7.5 1C3.9101 1 1 3.9101 1 7.5C1 11.0899 3.9101 14 7.5 14Z" fill="#333"/></svg><span>Top Destination</span></div><div class="legend-item active" data-filter="circle-sm"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13,4H9l0-3L7.5,0L6,1v3H2L1,5v1h13V5L13,4z M7.5,1.5c0.4,0,0.7,0.3,0.7,0.8S7.9,3,7.5,3S6.7,2.7,6.7,2.2C6.7,1.8,7.1,1.5,7.5,1.5z M13,7H2v4l-1,1.5V14h13v-1.5L13,11V7z M5,12.5H4V8h1V12.5z M8,12.5H7V8h1V12.5z M11,12.5h-1V8h1V12.5z" fill="#333"/></svg><span>City or Town</span></div><div class="legend-item active" data-filter="square-sm"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M11,4H4C3.4477,4,3,3.5523,3,3V0.5C3,0.2239,3.2239,0,3.5,0S4,0.2239,4,0.5V2h1V1c0-0.5523,0.4477-1,1-1s1,0.4477,1,1v1h1V1c0-0.5523,0.4477-1,1-1s1,0.4477,1,1v1h1V0.5C11,0.2239,11.2239,0,11.5,0S12,0.2239,12,0.5V3C12,3.5523,11.5523,4,11,4z M14,14.5c0,0.2761-0.2239,0.5-0.5,0.5h-12C1.2239,15,1,14.7761,1,14.5S1.2239,14,1.5,14H2c0.5523,0,1-0.4477,1-1c0,0,1-6,1-7c0-0.5523,0.4477-1,1-1h5c0.5523,0,1,0.4477,1,1c0,1,1,7,1,7c0,0.5523,0.4477,1,1,1h0.5c0.2723-0.0001,0.4946,0.2178,0.5,0.49V14.5z M9,10.5C9,9.6716,8.3284,9,7.5,9S6,9.6716,6,10.5V14h3V10.5z" fill="#333"/></svg><span>Castle or Palace</span></div><div class="legend-item active" data-filter="museum"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0L1,3.5V4h13V3.5L7.5,0z M2,5v5l-1,1.6V13h13v-1.4L13,10V5H2z M4,6h1v5.5H4V6z M7,6h1v5.5H7V6z M10,6h1v5.5h-1V6z" fill="#333"/></svg><span>Open-Air Museum</span></div><div class="legend-item active" data-filter="crosshammer"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M14,1v12H1V8.72c0.0016-0.1419,0.0634-0.2764,0.17-0.37l3-3.22c0.2074-0.1823,0.5234-0.1618,0.7056,0.0456C4.9568,5.268,5.0011,5.387,5,5.51v3l3.16-3.37c0.2025-0.1878,0.5188-0.1759,0.7066,0.0266C8.9532,5.2599,9.0009,5.3827,9,5.51V11h3V1H14z" fill="#333"/></svg><span>Industrial Museum</span></div><div class="legend-item active" data-filter="lookout-360"><svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M6.02,8.425a2.3859,2.3859,0,0,0-.46.44l-4.55-3.5a7.9976,7.9976,0,0,1,1.51-1.51Zm6.46-4.56-3.5,4.55a2.3971,2.3971,0,0,1,.45.45l4.56-3.5A7.945,7.945,0,0,0,12.48,3.865ZM7.3042,10.0129a1.5,1.5,0,1,0,1.6829,1.2914h0A1.5,1.5,0,0,0,7.3042,10.0129ZM6.43,2.235a7.9329,7.9329,0,0,0-2.06.55l2.2,5.32a2.0438,2.0438,0,0,1,.61-.17Zm2.14.01-.75,5.69a2.49,2.49,0,0,1,.61.16l2.2-5.3A7.2129,7.2129,0,0,0,8.57,2.245Z" fill="#333"/></svg><span>Viewpoint</span></div><div class="legend-item active" data-filter="religious-christian"><svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M6.5,0V1h-3v2h3v11h2V3h3V1h-3V0H6.5z" fill="#333"/></svg><span>Church</span></div><div class="legend-item active" data-filter="religious-jewish"><svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0l-2,2h-4v2l2,2l-2,2v2h4l2,2l2-2h4v-2l-2-2l2-2v-2h-4L7.5,0z M7.5,3l1,1h2l-1,1l1,1l-1,1l1,1h-2l-1,1l-1-1h-2l1-1l-1-1l1-1l-1-1h2L7.5,3z" fill="#333"/></svg><span>Synagogue</span></div><div class="legend-item active" data-filter="monument"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0L6,2.5v7h3v-7L7.5,0z M3,11.5L3,15h9v-3.5L10.5,10h-6L3,11.5z" fill="#333"/></svg><span>Other Destinations</span></div></div><div class="legend-section"><h5>Areas & Routes</h5><div class="legend-item active" data-filter="national-parks"><span class="color-indicator" style="background-color: #285c3a"></span><span>National Parks</span></div><div class="legend-item active" data-filter="railroads"><span class="color-indicator" style="background-color: #a87348"></span><span>Railroads</span></div><div class="legend-item active" data-filter="vineyards"><span class="color-indicator" style="background-color: #7e09a5"></span><span>Vineyards</span></div><div class="legend-item inactive" data-filter="cultural-landscapes"><span class="color-indicator" style="background-color: #376da1"></span><span>Cultural Landscapes</span></div></div>';
}

// --- Mobile Legend ---
function setupMobileLegend(map, activeFilters) {
  const overlay = document.getElementById("legend-mobile");
  const legendToggle = document.getElementById("legend-toggle");
  const legendClose = document.getElementById("legend-close");

  overlay.innerHTML = getLegend();

  legendToggle.addEventListener("click", () => {
    overlay.style.display = overlay.style.display === "block" ? "none" : "block";
    legendToggle.textContent = overlay.style.display === "block" ? "Hide Legend" : "Show Legend";
  });

  legendClose.addEventListener("click", () => {
    overlay.style.display = "none";
    legendToggle.textContent = "Show Legend";
  });

  setupLegendFilters(overlay, map, activeFilters);
}

// --- Desktop Legend ---
function setupDesktopLegend(map, activeFilters) {
  const overlay = document.getElementById("legend");

  overlay.style.display = "block";
  overlay.innerHTML = getLegend();

  function checkLegendVisibility() {
    const mapContainer = document.querySelector(".map-container");
    const mapWidth = mapContainer.offsetWidth;
    const legendWidth = overlay.offsetWidth;
    overlay.style.display = legendWidth > mapWidth * 0.5 ? "none" : "block";
  }

  setupLegendFilters(overlay, map, activeFilters);

  setTimeout(() => { checkLegendVisibility(); }, 100);
  window.addEventListener("resize", checkLegendVisibility);
}

// --- Mobile Click Events ---
function setupMobileClickEvents(map) {
  ["places-icons-regional", "places-icons-priority", "places-icons-city"].forEach(layerId => {
    map.on("click", layerId, (e) => {
      const wikipediaUrl = e.features[0].properties.Wikipedia || "";
      if (wikipediaUrl) window.open(wikipediaUrl, "_blank");
    });

    map.on("mouseenter", layerId, () => {
      map.getCanvas().style.cursor = "pointer";
    });

    map.on("mouseleave", layerId, () => {
      map.getCanvas().style.cursor = "";
    });
  });
}

// --- Desktop Popups (fixes listener leak — Bug 4) ---
function setupDesktopPopups(map) {
  let popup = null;
  let popupTimeout = null;
  let showPopupTimeout = null;

  function clearTimers() {
    if (popupTimeout) { clearTimeout(popupTimeout); popupTimeout = null; }
    if (showPopupTimeout) { clearTimeout(showPopupTimeout); showPopupTimeout = null; }
  }

  function removePopup() {
    if (popup) { popup.remove(); popup = null; }
  }

  function setupPlacesLayerEvents(layerId) {
    map.on("mouseenter", layerId, (e) => {
      map.getCanvas().style.cursor = "pointer";
      clearTimers();
      removePopup();

      const feature = e.features[0];
      const name = feature.properties.title || feature.properties.name || "Unknown Location";
      const wikipediaUrl = feature.properties.Wikipedia || "";
      const buttonDisabled = !wikipediaUrl ? " disabled" : "";
      const popupContent = '<div class="popup-content">' +
        '<button class="popup-close">\u00D7</button>' +
        '<div class="popup-title">' + name + '</div>' +
        '<button class="popup-button"' + buttonDisabled +
        ' data-wikipedia-url="' + (wikipediaUrl || "") + '">View on Wikipedia</button></div>';

      showPopupTimeout = setTimeout(() => {
        popup = new mapboxgl.Popup({
          closeButton: false,
          closeOnClick: false,
          offset: [0, -15]
        })
          .trackPointer()
          .setLngLat(e.lngLat)
          .setHTML(popupContent)
          .addTo(map);

        // Attach hover listeners ONCE per popup creation (fixes Bug 4)
        const popupElement = popup.getElement();

        popupElement.addEventListener("mouseenter", () => {
          if (popupTimeout) { clearTimeout(popupTimeout); popupTimeout = null; }
        });

        popupElement.addEventListener("mouseleave", () => {
          popupTimeout = setTimeout(() => { removePopup(); }, 500);
        });

        const closeBtn = popupElement.querySelector(".popup-close");
        const wikiBtn = popupElement.querySelector(".popup-button");

        if (closeBtn) {
          closeBtn.addEventListener("click", () => { removePopup(); });
        }

        if (wikiBtn && !wikiBtn.disabled) {
          wikiBtn.addEventListener("click", () => {
            const url = wikiBtn.getAttribute("data-wikipedia-url");
            if (url) window.open(url, "_blank");
          });
        }

        showPopupTimeout = null;
      }, 1000);
    });

    map.on("mouseleave", layerId, () => {
      map.getCanvas().style.cursor = "";
      if (showPopupTimeout) { clearTimeout(showPopupTimeout); showPopupTimeout = null; }
      if (popup) {
        popupTimeout = setTimeout(() => { removePopup(); }, 1000);
      }
    });

    map.on("click", layerId, (e) => {
      const wikipediaUrl = e.features[0].properties.Wikipedia;
      if (wikipediaUrl) window.open(wikipediaUrl, "_blank");
    });
  }

  setupPlacesLayerEvents("places-icons-regional");
  setupPlacesLayerEvents("places-icons-priority");
  setupPlacesLayerEvents("places-icons-city");

  // Dismiss popup when clicking outside it
  map.on("click", (e) => {
    if (!e.originalEvent.target.closest(".mapboxgl-popup")) {
      removePopup();
    }
  });
}

// --- Main Initialization ---
function initializeMap() {
  mapboxgl.accessToken = MAPBOX_TOKEN;
  const isMobile = window.innerWidth <= 991;

  // 1. Check for region bbox match (Feature 1)
  const bbox = getLocationBbox();

  // 2. Build map constructor options
  const mapOptions = {
    container: "map",
    style: MAP_STYLE,
    cooperativeGestures: isMobile,
    optimizeForTerrain: true,
    fadeDuration: 300,
    crossSourceCollisions: true,
    hash: true
  };

  if (bbox) {
    // Use fitBounds via constructor — perfectly frames the region (Feature 1)
    mapOptions.bounds = bbox;
    mapOptions.fitBoundsOptions = { padding: isMobile ? 30 : 60 };
  } else {
    // Default view — no region matched
    mapOptions.center = DEFAULT_CENTER;
    mapOptions.zoom = isMobile ? DEFAULT_ZOOM_MOBILE : DEFAULT_ZOOM_DESKTOP;
  }

  const map = new mapboxgl.Map(mapOptions);
  map.on("error", (e) => console.error("Map error:", e.error));

  // 3. On load — all shared setup
  map.on("load", () => {
    addSources(map);
    map.setTerrain({ source: "mapbox-dem", exaggeration: 1.5 });
    addSkyLayer(map);
    addOverlayLayers(map);
    addPlacesLayers(map);
    addMapControls(map);

    const activeFilters = new Set(DEFAULT_ACTIVE_FILTERS);
    applyPlacesFilter(map, Array.from(activeFilters));

    // 4. Only divergence: legend UI + interaction style
    if (isMobile) {
      setupMobileLegend(map, activeFilters);
      setupMobileClickEvents(map);
    } else {
      setupDesktopLegend(map, activeFilters);
      setupDesktopPopups(map);
    }

    // 5. ARIA labels on idle (Feature 3)
    setupAriaLabels(map, isMobile ? "#legend-mobile" : "#legend");
  });
}

// --- Boot ---
loadLocationConfig().then(() => { initializeMap(); });
</script>