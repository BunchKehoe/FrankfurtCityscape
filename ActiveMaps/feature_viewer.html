<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Regions Feature Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        #controls {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        #map {
            flex: 1;
            position: relative;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            background: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #757575;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #616161;
        }
        
        #info {
            flex: 1;
            font-size: 14px;
            color: #333;
        }
        
        #featureInfo {
            padding: 10px 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 10px;
            border-radius: 4px;
            position: absolute;
            top: 0;
            right: 0;
            max-width: 350px;
            z-index: 1000;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        #featureInfo h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: #333;
        }
        
        #featureInfo p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        
        #featureInfo .label {
            font-weight: 600;
            color: #333;
        }
        
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .counter {
            font-weight: 600;
            color: #2196F3;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button class="btn" id="prevBtn">← Previous</button>
        <button class="btn" id="nextBtn">Next →</button>
        <select id="featureSelect">
            <option value="">Loading features...</option>
        </select>
        <div id="info">
            <span class="counter" id="counter">0 / 0</span>
        </div>
        <button class="btn btn-secondary" id="fitBtn">Fit to Bounds</button>
        <button class="btn btn-secondary" id="resetBtn">Reset View</button>
    </div>
    
    <div id="map">
        <div id="featureInfo" style="display: none;">
            <h3 id="featureName">Feature Name</h3>
            <p><span class="label">Center:</span> <span id="centerCoords">-</span></p>
            <p><span class="label">Zoom Level:</span> <span id="zoomLevel">-</span></p>
            <p><span class="label">Bbox Size:</span> <span id="bboxSize">-</span></p>
            <p><span class="label">Region:</span> <span id="region">-</span></p>
            <p><span class="label">Empire:</span> <span id="empire">-</span></p>
        </div>
    </div>

    <script>
        // Initialize map
        const map = L.map('map').setView([48.5, 13.5], 6);
        
        // Add base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);
        
        // Global state
        let geojsonData = null;
        let currentFeatureIndex = 0;
        let currentLayer = null;
        let bboxRectangle = null;
        
        // Load GeoJSON
        fetch('HistoricalRegions_cleaned.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonData = data;
                initializeViewer();
            })
            .catch(error => {
                console.error('Error loading GeoJSON:', error);
                alert('Error loading GeoJSON file. Make sure HistoricalRegions_cleaned.geojson is in the same directory.');
            });
        
        function calculateBoundingBox(coords) {
            let allCoords = [];
            
            function flattenCoords(coordArray) {
                if (typeof coordArray[0] === 'number') {
                    allCoords.push(coordArray);
                } else {
                    coordArray.forEach(item => flattenCoords(item));
                }
            }
            
            flattenCoords(coords);
            
            const lons = allCoords.map(c => c[0]);
            const lats = allCoords.map(c => c[1]);
            
            return {
                minLon: Math.min(...lons),
                maxLon: Math.max(...lons),
                minLat: Math.min(...lats),
                maxLat: Math.max(...lats)
            };
        }
        
        function initializeViewer() {
            // Populate dropdown
            const select = document.getElementById('featureSelect');
            select.innerHTML = geojsonData.features.map((feature, index) => {
                const name = feature.properties.name || `Feature ${index + 1}`;
                return `<option value="${index}">${index + 1}. ${name}</option>`;
            }).join('');
            
            // Event listeners
            document.getElementById('prevBtn').addEventListener('click', () => navigateFeature(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigateFeature(1));
            document.getElementById('fitBtn').addEventListener('click', () => showCurrentFeature());
            document.getElementById('resetBtn').addEventListener('click', () => {
                map.setView([48.5, 13.5], 6);
            });
            
            select.addEventListener('change', (e) => {
                currentFeatureIndex = parseInt(e.target.value);
                showCurrentFeature();
            });
            
            // Show first feature
            showCurrentFeature();
        }
        
        function navigateFeature(direction) {
            currentFeatureIndex += direction;
            
            if (currentFeatureIndex < 0) {
                currentFeatureIndex = geojsonData.features.length - 1;
            } else if (currentFeatureIndex >= geojsonData.features.length) {
                currentFeatureIndex = 0;
            }
            
            document.getElementById('featureSelect').value = currentFeatureIndex;
            showCurrentFeature();
        }
        
        function showCurrentFeature() {
            const feature = geojsonData.features[currentFeatureIndex];
            
            // Remove previous layers
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }
            if (bboxRectangle) {
                map.removeLayer(bboxRectangle);
            }
            
            // Calculate bounding box
            const bbox = calculateBoundingBox(feature.geometry.coordinates);
            const center = {
                lat: (bbox.minLat + bbox.maxLat) / 2,
                lon: (bbox.minLon + bbox.maxLon) / 2
            };
            
            // Draw bounding box rectangle
            bboxRectangle = L.rectangle(
                [[bbox.minLat, bbox.minLon], [bbox.maxLat, bbox.maxLon]],
                {
                    color: '#FF6B6B',
                    weight: 2,
                    fillOpacity: 0.05,
                    dashArray: '5, 5'
                }
            ).addTo(map);
            
            // Add feature layer
            currentLayer = L.geoJSON(feature, {
                style: {
                    color: '#2196F3',
                    weight: 2,
                    fillColor: '#2196F3',
                    fillOpacity: 0.3
                }
            }).addTo(map);
            
            // Fit map to bounding box with padding
            map.fitBounds([[bbox.minLat, bbox.minLon], [bbox.maxLat, bbox.maxLon]], {
                padding: [50, 50]
            });
            
            // Update info panel
            const name = feature.properties.name || `Feature ${currentFeatureIndex + 1}`;
            document.getElementById('featureName').textContent = name;
            document.getElementById('centerCoords').textContent = 
                `[${center.lon.toFixed(6)}, ${center.lat.toFixed(6)}]`;
            document.getElementById('zoomLevel').textContent = map.getZoom();
            document.getElementById('bboxSize').textContent = 
                `${(bbox.maxLon - bbox.minLon).toFixed(6)}° × ${(bbox.maxLat - bbox.minLat).toFixed(6)}°`;
            document.getElementById('region').textContent = feature.properties.region || '-';
            document.getElementById('empire').textContent = feature.properties.empire || '-';
            document.getElementById('featureInfo').style.display = 'block';
            
            // Update counter
            document.getElementById('counter').textContent = 
                `${currentFeatureIndex + 1} / ${geojsonData.features.length}`;
            
            // Update button states
            document.getElementById('prevBtn').disabled = false;
            document.getElementById('nextBtn').disabled = false;
        }
    </script>
</body>
</html>
