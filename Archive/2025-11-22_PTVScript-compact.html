<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.css" rel="stylesheet"/>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.9.0/mapbox-gl.js"></script>
<style>
:root{--primary-red:#c00;--primary-green:#285c3a;--shadow-light:rgba(0,0,0,.1);--shadow-medium:rgba(0,0,0,.15)}
*{box-sizing:border-box}
@import url("https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap");
.map{width:100%;height:100%;border-radius:8px;overflow:visible}
.map-container{width:100%;height:700px;position:relative;border-radius:8px;overflow:visible;box-shadow:0 4px 12px var(--shadow-medium)}
.mapboxgl-popup{max-width:400px;font-family:"Open Sans",-apple-system,sans-serif;font-size:.875rem;line-height:1.5}
.mapboxgl-popup-content{padding:12px;border-radius:8px}
.popup-content{text-align:center}
.popup-title{font-weight:600;margin-bottom:8px;color:#333}
.popup-button{background:var(--primary-red);color:#fff;border:none;padding:4px 12px;border-radius:4px;font-size:.875rem;font-weight:600;cursor:pointer;transition:background-color .2s}
.popup-button:hover{background:#a00}
.popup-button:disabled{background:#ccc;cursor:not-allowed}
.popup-close{position:absolute;top:8px;right:8px;background:0 0;border:none;font-size:18px;cursor:pointer;color:#999;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}
.popup-close:hover{background:#f0f0f0;color:#666}
.legend{max-width:280px;width:45%;max-height:90%;overflow-y:auto;display:none;background:#fff;border-radius:8px;top:16px;left:16px;box-shadow:0 4px 12px var(--shadow-medium);font-family:"Open Sans",sans-serif;font-size:.875rem;padding:16px;position:absolute;z-index:1000;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
.legend-mobile{background:#fff;display:none;border-radius:8px;box-shadow:0 2px 8px var(--shadow-light);font-family:"Open Sans",sans-serif;font-size:.875rem;padding:16px;position:absolute;width:85%;max-height:70vh;overflow-y:auto;left:50%;top:60px;transform:translateX(-50%);z-index:9999;max-width:280px}
.legend-toggle-btn{position:absolute;top:10px;left:10px;z-index:9000;background:#fff;border:none;border-radius:8px;box-shadow:0 2px 6px var(--shadow-light);padding:8px 12px;font-size:.875rem;font-weight:600;cursor:pointer;display:none}
.legend-close-btn{position:absolute;top:10px;right:10px;background:0 0;border:none;font-size:18px;cursor:pointer;color:#666}
.legend h4,.legend-mobile h4{margin:0 0 12px;font-size:1.125rem;font-weight:700;color:#333;border-bottom:2px solid #f0f0f0;padding-bottom:4px}
.legend-section{margin-bottom:12px}
.legend-section:last-child{margin-bottom:0}
.legend-section h5{margin:0 0 4px;font-size:.875rem;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:.5px}
.legend-item{display:flex;align-items:center;margin-bottom:4px;padding:2px 0;transition:all .2s;cursor:pointer;border-radius:4px}
.legend-item:hover{background:#f8f9fa;padding-left:4px;padding-right:4px}
.legend-item.active{background:#e3f2fd;padding-left:4px;padding-right:4px}
.legend-item.inactive{opacity:.4;background:#f5f5f5;padding-left:4px;padding-right:4px}
.legend-item.inactive svg,.legend-item.inactive .color-indicator{opacity:.5}
.legend-item svg{margin-right:8px;flex-shrink:0}
.legend-item span.color-indicator{display:inline-block;width:15px;height:15px;margin-right:8px;border-radius:2px;flex-shrink:0}
.destination-type{font-weight:600;margin-bottom:2px}
.destination-type.top{color:var(--primary-red)}
.destination-type.worth{color:var(--primary-red);font-weight:400}
.destination-type.special{color:#666;font-weight:300}
.destination-type.natural{color:var(--primary-green);font-style:italic;font-weight:600}
@media(max-width:991px){.map-container{height:600px}.legend{max-width:220px;width:40%;padding:12px}.map-container{border-radius:4px}}
@media(max-width:576px){.legend{display:none!important}.legend-mobile{display:none}.legend-toggle-btn{display:block}.legend h4{font-size:1rem}}
</style>
<div class="map-container">
<div id="map" class="map"></div>
<div id="legend" class="legend"></div>
<button id="legend-toggle" class="legend-toggle-btn">Show Legend</button>
<div id="legend-mobile" class="legend-mobile"><button id="legend-close" class="legend-close-btn">×</button></div>
</div>
<script>
const TOKEN="pk.eyJ1IjoiamNidW5jaDMiLCJhIjoiY2t6NzM0em9uMGlvbzMwbWdkbmR5N2loaCJ9.eKquRAbhpJDDshFFKtd9Yw";
const STYLE="mapbox://styles/jcbunch3/cljssqa5h01ch01o4adoyhdlt";
const SOURCES={places:"mapbox://jcbunch3.cmd6clxb92tlo1ns8ro5qgig8-6jlvw","cultural-landscapes":"mapbox://jcbunch3.9b7pcnhy","national-parks":"mapbox://jcbunch3.clkc6qkel2xr42aleuq3sjnsq-0zrfg",railroads:"mapbox://jcbunch3.8o05xvpq",vineyards:"mapbox://jcbunch3.86vjg7du","mapbox-dem":"mapbox://mapbox.mapbox-terrain-dem-v1"};
mapboxgl.accessToken=TOKEN;

const getLegend=()=>`<h4>Map Legend</h4><div class="legend-section"><h5>Places by Importance</h5><div class="legend-item"><div class="destination-type top">Top Destinations</div></div><div class="legend-item"><div class="destination-type worth">Worth a Visit</div></div><div class="legend-item"><div class="destination-type special">Special Interest</div></div><div class="legend-item"><div class="destination-type natural">Beautiful Landscape</div></div></div><div class="legend-section"><h5>Location Types</h5><div class="legend-item active" data-filter="city"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M7.5 12.3C4.84898 12.3 2.7 10.151 2.7 7.5C2.7 4.84898 4.84898 2.7 7.5 2.7C10.151 2.7 12.3 4.84898 12.3 7.5C12.3 10.151 10.151 12.3 7.5 12.3ZM7.5 14C11.0899 14 14 11.0899 14 7.5C14 3.9101 11.0899 1 7.5 1C3.9101 1 1 3.9101 1 7.5C1 11.0899 3.9101 14 7.5 14Z" fill="#333"/></svg><span>Top Destination</span></div><div class="legend-item active" data-filter="circle-sm"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M13,4H9l0-3L7.5,0L6,1v3H2L1,5v1h13V5L13,4z M7.5,1.5c0.4,0,0.7,0.3,0.7,0.8S7.9,3,7.5,3S6.7,2.7,6.7,2.2C6.7,1.8,7.1,1.5,7.5,1.5z M13,7H2v4l-1,1.5V14h13v-1.5L13,11V7z M5,12.5H4V8h1V12.5z M8,12.5H7V8h1V12.5z M11,12.5h-1V8h1V12.5z" fill="#333"/></svg><span>City or Town</span></div><div class="legend-item active" data-filter="square-sm"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M11,4H4C3.4477,4,3,3.5523,3,3V0.5C3,0.2239,3.2239,0,3.5,0S4,0.2239,4,0.5V2h1V1c0-0.5523,0.4477-1,1-1s1,0.4477,1,1v1h1V1c0-0.5523,0.4477-1,1-1s1,0.4477,1,1v1h1V0.5C11,0.2239,11.2239,0,11.5,0S12,0.2239,12,0.5V3C12,3.5523,11.5523,4,11,4z M14,14.5c0,0.2761-0.2239,0.5-0.5,0.5h-12C1.2239,15,1,14.7761,1,14.5S1.2239,14,1.5,14H2c0.5523,0,1-0.4477,1-1c0,0,1-6,1-7c0-0.5523,0.4477-1,1-1h5c0.5523,0,1,0.4477,1,1c0,1,1,7,1,7c0,0.5523,0.4477,1,1,1h0.5c0.2723-0.0001,0.4946,0.2178,0.5,0.49V14.5z M9,10.5C9,9.6716,8.3284,9,7.5,9S6,9.6716,6,10.5V14h3V10.5z" fill="#333"/></svg><span>Castle or Palace</span></div><div class="legend-item active" data-filter="monument"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0L6,2.5v7h3v-7L7.5,0z M3,11.5L3,15h9v-3.5L10.5,10h-6L3,11.5z" fill="#333"/></svg><span>Monument</span></div><div class="legend-item active" data-filter="museum"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0L1,3.5V4h13V3.5L7.5,0z M2,5v5l-1,1.6V13h13v-1.4L13,10V5H2z M4,6h1v5.5H4V6z M7,6h1v5.5H7V6z M10,6h1v5.5h-1V6z" fill="#333"/></svg><span>Open-Air Museum</span></div><div class="legend-item active" data-filter="crosshammer"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M14,1v12H1V8.72c0.0016-0.1419,0.0634-0.2764,0.17-0.37l3-3.22c0.2074-0.1823,0.5234-0.1618,0.7056,0.0456C4.9568,5.268,5.0011,5.387,5,5.51v3l3.16-3.37c0.2025-0.1878,0.5188-0.1759,0.7066,0.0266C8.9532,5.2599,9.0009,5.3827,9,5.51V11h3V1H14z" fill="#333"/></svg><span>Industrial Museum</span></div><div class="legend-item active" data-filter="lookout-360"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M6.02,8.425a2.3859,2.3859,0,0,0-.46.44l-4.55-3.5a7.9976,7.9976,0,0,1,1.51-1.51Zm6.46-4.56-3.5,4.55a2.3971,2.3971,0,0,1,.45.45l4.56-3.5A7.945,7.945,0,0,0,12.48,3.865ZM7.3042,10.0129a1.5,1.5,0,1,0,1.6829,1.2914h0A1.5,1.5,0,0,0,7.3042,10.0129ZM6.43,2.235a7.9329,7.9329,0,0,0-2.06.55l2.2,5.32a2.0438,2.0438,0,0,1,.61-.17Zm2.14.01-.75,5.69a2.49,2.49,0,0,1,.61.16l2.2-5.3A7.2129,7.2129,0,0,0,8.57,2.245Z" fill="#333"/></svg><span>Viewpoint</span></div><div class="legend-item active" data-filter="religious-christian"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M6.5,0V1h-3v2h3v11h2V3h3V1h-3V0H6.5z" fill="#333"/></svg><span>Church</span></div><div class="legend-item active" data-filter="religious-jewish"><svg width="15" height="15" viewBox="0 0 15 15"><path d="M7.5,0l-2,2h-4v2l2,2l-2,2v2h4l2,2l2-2h4v-2l-2-2l2-2v-2h-4L7.5,0z M7.5,3l1,1h2l-1,1l1,1l-1,1l1,1h-2l-1,1l-1-1h-2l1-1l-1-1l1-1l-1-1h2L7.5,3z" fill="#333"/></svg><span>Synagogue</span></div></div><div class="legend-section"><h5>Areas & Routes</h5><div class="legend-item active" data-filter="national-parks"><span class="color-indicator" style="background-color:#285c3a"></span><span>National Parks</span></div><div class="legend-item active" data-filter="railroads"><span class="color-indicator" style="background-color:#a87348"></span><span>Railroads</span></div><div class="legend-item active" data-filter="vineyards"><span class="color-indicator" style="background-color:#7e09a5"></span><span>Vineyards</span></div><div class="legend-item inactive" data-filter="cultural-landscapes"><span class="color-indicator" style="background-color:#376da1"></span><span>Cultural Landscapes</span></div></div>`;

const LOC_CFG={"interactive-map":{c:[8.7,50.1],z:{m:4.25,d:7}},shopluk:{c:[22.8,41.9],z:{m:7,d:7.5}},pirin:{c:[23.4,41.5],z:8},dobruja:{c:[28,43.5],z:6.5},"northern-bulgaria":{c:[25,41],z:{m:6,d:7}},"thracian-valley":{c:[25.5,41.4],z:{m:6.5,d:7.5}},strandzha:{c:[27.3,42],z:7.5},"rhodope-mountains":{c:[24.7,41.2],z:7.5},"western-thrace":{c:[25.4,40.8],z:8},holstein:{c:[10,53.7],z:8.5},mecklenburg:{c:[12.3,53.5],z:8.5},schleswig:{c:[9.2,54.6],z:8.5},slesvig:{c:[9.2,54.6],z:8.5},vorpommern:{c:[13.6,53.6],z:8.5},scania:{c:[14,55.8],z:8},sjaelland:{c:[11.9,55.2],z:8},fyn:{c:[10.3,55],z:8.5},jylland:{c:[9.5,56.5],z:8},uckermark:{c:[13.8,53.1],z:9.5},mittelmark:{c:[13.2,52.3],z:8},berlin:{c:[13.4,52.5],z:10},altmark:{c:[11.7,52.7],z:9},"lower-saxony":{c:[10.3,52.6],z:8},anhalt:{c:[12.1,51.75],z:9.5},eastphalia:{c:[11.1,51.6],z:8},thuringia:{c:[10.9,50.7],z:8.5},"electoral-saxony":{c:[13.2,51],z:8},lusatia:{c:[14.5,51.3],z:8.5},hessen:{c:[9.3,50.7],z:8.5},wetterau:{c:[9,50],z:9},"explore-frankfurt":{c:[9,50],z:9},westerwald:{c:[8,50.2],z:9},"the-ore-mountains":{c:[13.54,50.6],z:9},"main-franconia":{c:[10.1,50.05],z:9.5},"upper-franconia":{c:[11.1,50.05],z:9.5},"middle-franconia":{c:[10.8,49.1],z:9},odenwald:{c:[9.2,49.67],z:9},vogtland:{c:[12.1,50.3],z:9},hohenlohe:{c:[9.8,49.3],z:9},"upper-bavaria":{c:[11.7,48.1],z:8.5},"lower-bavaria":{c:[12.7,48.7],z:9},"upper-palatinate":{c:[12.15,49.4],z:9},allgau:{c:[10.3,47.6],z:9},oberschwaben:{c:[9.9,48.2],z:8.5},wurttemberg:{c:[9,48.4],z:8.5},"lake-constance-bodensee":{c:[9.2,47.6],z:10},"ducal-bar":{c:[5.5,49],z:9},lorraine:{c:[6.4,48.6],z:8.5},luxembourg:{c:[5.65,49.7],z:9},saarland:{c:[7,49.2],z:9.5},"middle-rhine-valley":{c:[7.6,50.25],z:9.5},"mosel-valley":{c:[6.9,50],z:9},"electoral-palatinate":{c:[8.15,49.4],z:9},alsace:{c:[7.5,48.5],z:9},baden:{c:[8.2,48.5],z:9},basel:{c:[6.9,50],z:9},"maas-valley":{c:[5.5,50.7],z:8.5},"lower-rhine-valley":{c:[6.5,51.2],z:9},"bergisches-land":{c:[7.3,50.9],z:9.5},"weser-engern":{c:[8.9,52.78],z:8.5},sauerland:{c:[8,51.1],z:9.5},westphalia:{c:[7.7,52.3],z:9},ruhr:{c:[7.7,52.3],z:9},emsland:{c:[7.7,52.7],z:8.5},"west-frisia":{c:[6.1,53.1],z:8.5},"east-frisia":{c:[7.5,53.5],z:8.5},"oldenburger-land":{c:[8.2,53.3],z:8.5},oversticht:{c:[6.4,52.6],z:9},holland:{c:[4.4,52.3],z:9},brabant:{c:[5.05,51.2],z:9},flanders:{c:[3.3,50.9],z:9},artois:{c:[3.3,50.9],z:9},picardy:{c:[3.3,50.9],z:9},hainaut:{c:[4,50.3],z:9},gelderland:{c:[5.6,52.1],z:9},florence:{c:[11.3,43.7],z:9},pisa:{c:[10.4,43.3],z:{m:9,d:9}},lucca:{c:[10.4,44],z:{m:9,d:10}},carrara:{c:[10.1,44.1],z:10},siena:{c:[11.3,43],z:9},"republic-of-florence":{c:[11.3,43.7],z:9},"republic-of-pisa":{c:[10.4,43.1],z:9},"republic-of-lucca":{c:[10.4,44],z:10},"duchy-of-massa-and-carrara":{c:[10.1,44],z:11},"republic-of-siena":{c:[11.3,42.8],z:9},vienna:{c:[16.4,48.2],z:10},eisenwurzen:{c:[14.64,47.84],z:9},"forest-district":{c:[15.28,48.66],z:9},wachau:{c:[15.42,48.2],z:10},"wine-district":{c:[16.44,48.6],z:9},salzburg:{c:[13.1,47.8],z:9},"lower-austria":{c:[15.89,48],z:9},"upper-austria":{c:[14.3,48.2],z:9},"upper-styria":{c:[15.2,47.1],z:9},"lower-styria":{c:[15.4,46.36],z:9},carinthia:{c:[13.9,46.7],z:9},carniola:{c:[14.56,45.9],z:9},"imperial-littoral":{c:[14,45.45],z:9}};

const applyLoc=(m,isMob)=>{const url=window.location.href;for(const[k,v]of Object.entries(LOC_CFG)){if(url.includes(k)){const z=typeof v.z==='object'?(isMob?v.z.m:v.z.d):v.z;m.setCenter(v.c);m.setZoom(z);break}}};

const addSrc=m=>Object.entries(SOURCES).forEach(([n,u])=>m.addSource(n,n==='mapbox-dem'?{type:'raster-dem',url:u,tileSize:512,maxzoom:14}:{type:"vector",url:u}));

const toggleLP=(m,f,l)=>{const v=m.getLayoutProperty(f,'visibility')==='visible'?'none':'visible';m.setLayoutProperty(f,'visibility',v);m.setLayoutProperty(l,'visibility',v);return v};
const toggleL=(m,i)=>{const v=m.getLayoutProperty(i,'visibility')==='visible'?'none':'visible';m.setLayoutProperty(i,'visibility',v);return v};

const isMob=window.innerWidth<=991;
const map=new mapboxgl.Map({container:"map",style:STYLE,center:[8.8,isMob?52.6:52.4],zoom:isMob?4:5.1,cooperativeGestures:isMob,optimizeForTerrain:true,fadeDuration:300,crossSourceCollisions:true});

map.on('error',e=>console.error('Map error:',e.error));

map.on("load",()=>{
addSrc(map);
map.setTerrain({source:'mapbox-dem',exaggeration:1.5});

const overlay=document.getElementById(isMob?"legend-mobile":"legend");
const legendToggle=document.getElementById("legend-toggle");
const legendClose=document.getElementById("legend-close");

overlay.innerHTML=getLegend();

if(isMob){
legendToggle.addEventListener('click',()=>{overlay.style.display=overlay.style.display==='block'?'none':'block';legendToggle.textContent=overlay.style.display==='block'?'Hide Legend':'Show Legend'});
legendClose.addEventListener('click',()=>{overlay.style.display='none';legendToggle.textContent='Show Legend'});
}else{
overlay.style.display="block";
const checkVis=()=>{const w=document.querySelector('.map-container').offsetWidth;overlay.style.display=overlay.offsetWidth>w*.5?"none":"block"};
setTimeout(checkVis,100);
window.addEventListener('resize',checkVis);
}

const activeFilters=new Set(['city','circle-sm','square-sm','monument','museum','crosshammer','lookout-360','religious-christian','religious-jewish','mountain','food']);

overlay.querySelectorAll('.legend-item[data-filter]').forEach(item=>{
item.addEventListener('click',e=>{
e.preventDefault();
const f=item.dataset.filter;
const toggles={'cultural-landscapes':()=>toggleLP(map,'cultural-landscapes-fill','cultural-landscapes-label'),'national-parks':()=>toggleLP(map,'national-parks-fill','national-parks-label'),railroads:()=>toggleL(map,'railroads'),vineyards:()=>toggleL(map,'vineyards')};
if(toggles[f]){
const v=toggles[f]();
item.classList.toggle('active',v==='visible');
item.classList.toggle('inactive',v==='none');
}else{
const layers=map.getStyle().layers.filter(l=>l.source==='places'&&l.type==='symbol');
if(activeFilters.has(f)){activeFilters.delete(f);item.classList.remove('active');item.classList.add('inactive')}
else{activeFilters.add(f);item.classList.remove('inactive');item.classList.add('active')}
const arr=Array.from(activeFilters);
layers.forEach(l=>map.setFilter(l.id,arr.length===0?['==','marker-symbol','none']:['in','marker-symbol',...arr]));
}});
});

const arr=Array.from(activeFilters);
const layers=map.getStyle().layers.filter(l=>l.source==='places'&&l.type==='symbol');
layers.forEach(l=>map.setFilter(l.id,arr.length===0?['==','marker-symbol','none']:['in','marker-symbol',...arr]));

['cultural-landscapes','national-parks','railroads','vineyards'].forEach((n,i)=>{
const cfg={type:['cultural-landscapes','national-parks','vineyards'].includes(n)?'fill':'line',source:n,"source-layer":n==='cultural-landscapes'?"Landscapes2-8zz5we":n==='national-parks'?"EuropeNationalParks":n==='railroads'?"EURailwaysComplete-cktonh":"WineTest3-7cv5f4",layout:{visibility:n==='cultural-landscapes'?"none":"visible"},paint:n==='railroads'?{"line-color":"#a87348","line-opacity":1,"line-width":2,"line-dasharray":[2,1]}:{"fill-color":n==='cultural-landscapes'?"#376da1":n==='national-parks'?"#285c3a":"#7e09a5","fill-opacity":n==='cultural-landscapes'?.5:n==='national-parks'?.2:.4}};
map.addLayer({id:n+(n!=='railroads'&&n!=='vineyards'?'-fill':''),...cfg});
if(n==='cultural-landscapes'||n==='national-parks'){
map.addLayer({id:n+'-label',type:'symbol',source:n,"source-layer":cfg["source-layer"],layout:{visibility:n==='cultural-landscapes'?"none":"visible","text-field":["get","NAM"],"text-font":["Open Sans Semibold Italic","Arial Unicode MS Bold"],"text-size":16,"text-anchor":"center","text-allow-overlap":false,"text-transform":"none"},paint:{"text-color":n==='cultural-landscapes'?"#376da1":"#285c3a","text-opacity":.7,"text-halo-color":"rgba(255,255,255,0.8)","text-halo-width":1.5}});
}});

map.on("click",e=>{
const features=map.queryRenderedFeatures(e.point,{filter:['==',['get','source'],'places']});
if(features.length>0){
const url=features[0].properties.Wikipedia;
if(url)window.open(url,"_blank");
}});

let isOver=false;
map.on("mousemove",e=>{
const features=map.queryRenderedFeatures(e.point,{filter:['==',['get','source'],'places']});
if(features.length>0&&!isOver){map.getCanvas().style.cursor="pointer";isOver=true}
else if(features.length===0&&isOver){map.getCanvas().style.cursor="";isOver=false}
});

if(!isMob){
let popup=null,popupTO=null,showTO=null;
map.on("mousemove",e=>{
const features=map.queryRenderedFeatures(e.point,{filter:['==',['get','source'],'places']});
if(features.length>0){
if(!isOver){
isOver=true;
if(popupTO)clearTimeout(popupTO);
if(showTO)clearTimeout(showTO);
const f=features[0];
const name=f.properties.title||f.properties.name||"Unknown Location";
const wiki=f.properties.Wikipedia||"";
const dis=!wiki?'disabled':'';
const html=`<div class="popup-content"><button class="popup-close">×</button><div class="popup-title">${name}</div><button class="popup-button" ${dis} data-wikipedia-url="${wiki}">View on Wikipedia</button></div>`;
showTO=setTimeout(()=>{
if(popup){popup.remove();popup=null}
popup=new mapboxgl.Popup({closeButton:false,closeOnClick:false,offset:[0,-15]}).trackPointer().setLngLat(e.lngLat).setHTML(html).addTo(map);
const el=popup.getElement();
el.querySelector('.popup-close').addEventListener('click',()=>{if(popup){popup.remove();popup=null}});
const btn=el.querySelector('.popup-button');
if(btn&&!btn.disabled)btn.addEventListener('click',()=>{const u=btn.getAttribute('data-wikipedia-url');if(u)window.open(u,'_blank')});
showTO=null;
},1000);
}}else{
if(isOver){
isOver=false;
if(showTO)clearTimeout(showTO);
if(popup)popupTO=setTimeout(()=>{if(popup){popup.remove();popup=null}},1000);
}}});
}

map.addControl(new mapboxgl.NavigationControl(),"top-right");
map.addControl(new mapboxgl.FullscreenControl(),"top-right");
map.addControl(new mapboxgl.GeolocateControl({positionOptions:{enableHighAccuracy:true},trackUserLocation:true,showUserHeading:true}),"top-right");
map.addControl(new mapboxgl.TerrainControl({source:'mapbox-dem',exaggeration:1.5}),'top-right');
map.addControl(new mapboxgl.ScaleControl({maxWidth:100,unit:'metric'}),'bottom-right');

applyLoc(map,isMob);
});
</script>
