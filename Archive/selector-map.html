<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  html, body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.4;
  }

  .map-container {
    width: 100%;
    height: 70vh;
    min-height: 600px;
  }

  /* If the parent container has a defined height, use that instead */
  .map-container-responsive {
    height: 100% !important;
  }

  .map {
    height: 100%;
  }

  .map-overlay {
    font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    background-color: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    position: absolute;
    width: 350px;
    top: 20px;
    left: 20px;
    padding: 20px;
    display: none;
    z-index: 1000;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
  }

  .popupgl {
    max-width: 380px;
    min-width: 320px;
    border: 2px solid #0a9396;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    z-index: 1001;
  }

  .popupgl.region-colored {
    border-width: 3px;
  }

  .popupgl .mapboxgl-popup-content {
    padding: 12px;
    border-radius: 6px;
    background: transparent;
  }

  .popupgl .popup-layout {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .popupgl .popup-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    border: 2px solid #f0f0f0;
  }

  .popupgl .popup-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: left;
  }

  .popupgl .popup-region-label {
    margin: 0 0 4px 0;
    font-size: 0.8em;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .popupgl .popup-title {
    margin: 0 0 4px 0;
    font-size: 1.3em;
    font-weight: 600;
    line-height: 1.3;
    color: #333;
  }

  .popupgl .popup-subtitle {
    margin: 0;
    font-size: 0.9em;
    color: #666;
    font-weight: 400;
    line-height: 1.2;
  }

  .popupgl .popup-description {
    margin: 0;
    font-size: 0.9em;
    line-height: 1.4;
    color: #555;
  }

  .popupgl .popup-click-hint {
    margin: 0;
    font-size: 0.85em;
    color: #0a9396;
    font-style: italic;
  }

  .mapboxgl-popup-tip {
    display: none;
  }

  .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip,
  .mapboxgl-popup-anchor-top .mapboxgl-popup-tip {
    display: none;
  }

  /* Mobile Styles */
  @media only screen and (max-width: 768px) {
    .map-container {
      height: 60vh;
      min-height: 400px;
    }

    .map {
      height: 100%;
    }
    
    .map-overlay.visible {
      display: block !important;
      transform: translateY(0);
    }

    .map-overlay {
      position: fixed !important;
      bottom: 0;
      left: 0;
      right: 0;
      top: auto;
      width: 100% !important;
      height: auto;
      max-height: 50vh;
      border-radius: 12px 12px 0 0;
      z-index: 9999 !important;
      background-color: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      overflow-y: auto;
      padding: 20px;
      transform: translateY(100%);
      transition: transform 0.3s ease-in-out;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
    }

    .map-overlay .close-button {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      background: rgba(0, 0, 0, 0.1);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: #666;
      transition: all 0.2s ease;
      z-index: 10000;
    }

    .map-overlay .close-button:hover {
      background: rgba(0, 0, 0, 0.2);
      color: #333;
    }

    .map-overlay .close-button::before {
      content: 'Ã—';
      font-weight: bold;
      line-height: 1;
    }

    .popupgl {
      max-width: 60px;
      min-width: 60px;
    }

    .popupgl .mapboxgl-popup-content {
      padding: 0;
    }

    .popupgl .popup-layout {
      display: block;
    }

    .popupgl .popup-image {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      display: block;
    }

    .popupgl .popup-content {
      display: none;
    }
  }

  /* Overlay Content Styles */
  .overlay-content {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    margin-bottom: 15px;
  }

  .overlay-image {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    border: 2px solid #f0f0f0;
  }

  .overlay-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    text-align: left;
  }

  .overlay-text h2,
  .overlay-text h3 {
    margin: 0 0 8px 0;
    font-size: 1.6em;
    font-weight: 600;
    color: #333;
  }

  .overlay-text .region-label {
    margin: 0 0 4px 0;
    font-size: 0.9em;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .overlay-text .main-title {
    margin: 0 0 4px 0;
    font-size: 1.6em;
    font-weight: 600;
    color: #333;
  }

  .overlay-text p {
    margin: 0 0 10px 0;
    font-size: 0.9em;
    line-height: 1.4;
    color: #555;
  }

  .overlay-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #0a9396;
    color: white;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
  }

  .overlay-button:hover {
    background-color: #087f83;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(10, 147, 150, 0.3);
  }

  .overlay-button:active {
    transform: translateY(0);
  }

  /* Remove old button styles */
  .button-59 {
    display: none;
  }

  /* Utility classes */
  .center {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .left {
    margin: 0;
    text-align: left;
  }

  .regionleft {
    margin: 0;
    text-align: left;
  }

  .row {
    display: flex;
    align-items: flex-start;
    gap: 15px;
  }

  .container {
    display: flex;
    align-items: flex-start;
    gap: 15px;
  }

  .text {
    flex: 1;
  }

  .infoImg {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    flex-shrink: 0;
    border: 2px solid #f0f0f0;
  }
</style>

<div class="map-container">
  <div id="map" class="map"></div>
  <div id="map-overlay" class="map-overlay"></div>
</div>

<script>
  var regionStyle = {
    fillColor: '#3388ff',
    weight: 0,
    color: '#3388ff',
    fillOpacity: 0
  };

  var SelectStyle = {
    fillColor: '#6c757d',
    weight: 2,
    color: '#6c757d',
    fillOpacity: 0.7
  };

  var popupOptionsMobile = {
    autoPan: false,
    className: 'another-popup'
  };

  var popupOptions = {
    maxWidth: 300,
    autoPan: false,
    className: 'another-popup'
  };

  // adding the province name to the visible div
  function addTextToDiv(text) {
    const markerPlace = document.querySelector('.marker-position');
    markerPlace.textContent = text;
  }

  function removeFilters(map) {
    if (map.getLayer('regions-highlighted')) {
      map.setFilter('regions-highlighted', ['in', 'region', '']);
    }
    if (map.getLayer('subregions-highlighted')) {
      map.setFilter('subregions-highlighted', ['in', 'name', '']);
    }
    if (map.getLayer('empires-highlighted')) {
      map.setFilter('empires-highlighted', ['in', 'empire', '']);
    }
  }

  function getMobileCountryPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var popUp =
        '<div class="popup-layout">' +
        '<a href="' +
        feature.properties.url +
        '"><img class="popup-image" src="' +
        feature.properties.icourl +
        '"/></a>' +
        '</div>';
      return popUp;
    }
  }

  function getMobileEmpirePopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var popUp =
        '<div class="popup-layout">' +
        '<a href="' +
        feature.properties.empireUrl +
        '"><img class="popup-image" src="' +
        feature.properties.empireIcoUrl +
        '"/></a>' +
        '</div>';
      return popUp;
    }
  }

  function getMobileRegionPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var popUp =
        '<div class="popup-layout">' +
        '<a href="' +
        feature.properties.regionUrl +
        '"><img class="popup-image" src="' +
        feature.properties.regionIcoUrl +
        '"/></a>' +
        '</div>';
      return popUp;
    }
  }

  function getMobileSubRegionPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var popUp =
        '<div class="popup-layout">' +
        '<a href="' +
        feature.properties.url +
        '"><img class="popup-image" src="' +
        feature.properties.icoUrl +
        '"/></a>' +
        '</div>';
      return popUp;
    }
  }

  function getMobileCountrySidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var sideBar =
        '<button class="close-button" onclick="closeMobileSidebar()"></button>' +
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.icourl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h2>' +
        feature.properties.name +
        '</h2>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.desc +
        '</p>' +
        '<div class="center"><a href="' +
        feature.properties.url +
        '" class="overlay-button">Discover More</a></div>';
      return sideBar;
    }
  }

  function getMobileEmpireSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<button class="close-button" onclick="closeMobileSidebar()"></button>' +
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.empireIcoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h2 class="main-title">' +
        feature.properties.empire +
        '</h2>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.empireDesc +
        '</p>' +
        '<div class="center"><a href="' +
        feature.properties.empireUrl +
        '" class="overlay-button">Discover More</a></div>';
      return sideBar;
    }
  }

  function getMobileRegionSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<button class="close-button" onclick="closeMobileSidebar()"></button>' +
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.regionIcoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h2 class="main-title">' +
        feature.properties.region +
        '</h2>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.regionDesc +
        '</p>' +
        '<div class="center"><a href="' +
        feature.properties.regionUrl +
        '" class="overlay-button">Discover More</a></div>';
      return sideBar;
    }
  }

  function getMobileSubRegionSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<button class="close-button" onclick="closeMobileSidebar()"></button>' +
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.icoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<div class="region-label">' +
        feature.properties.region +
        '</div>' +
        '<h2 class="main-title">' +
        feature.properties.name +
        '</h2>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.desc +
        '</p>' +
        '<div class="center"><a href="' +
        feature.properties.url +
        '" class="overlay-button">Discover More</a></div>';
      return sideBar;
    }
  }

  function getCountryPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var popUp =
        '<div class="popup-layout">' +
        '<img class="popup-image" src="' +
        feature.properties.icourl +
        '"/>' +
        '<div class="popup-content">' +
        '<h2 class="popup-title">' +
        feature.properties.name +
        '</h2>' +
        '<p class="popup-click-hint">Click on the Map to Learn More</p>' +
        '</div>' +
        '</div>';
      return { html: popUp, borderColor: null };
    }
  }

  function getEmpirePopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var popUp =
        '<div class="popup-layout">' +
        '<img class="popup-image" src="' +
        feature.properties.empireIcoUrl +
        '"/>' +
        '<div class="popup-content">' +
        '<h2 class="popup-title">' +
        feature.properties.empire +
        '</h2>' +
        '<p class="popup-subtitle">' +
        feature.properties.region +
        '</p>' +
        '</div>' +
        '</div>';
      return { html: popUp, borderColor: regionColor };
    }
  }

  function getRegionPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var popUp =
        '<div class="popup-layout">' +
        '<img class="popup-image" src="' +
        feature.properties.regionIcoUrl +
        '"/>' +
        '<div class="popup-content">' +
        '<h3 class="popup-title">' +
        feature.properties.region +
        '</h3>' +
        '<p class="popup-subtitle">' +
        feature.properties.subtitle +
        '</p>' +
        '</div>' +
        '</div>';
      return { html: popUp, borderColor: regionColor };
    }
  }

  function getSubRegionPopupHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var popUp =
        '<div class="popup-layout">' +
        '<img class="popup-image" src="' +
        feature.properties.icoUrl +
        '"/>' +
        '<div class="popup-content">' +
        '<div class="popup-region-label">' +
        feature.properties.region +
        '</div>' +
        '<h3 class="popup-title">' +
        feature.properties.name +
        '</h3>' +
        '<p class="popup-description">' +
        feature.properties.subtitle +
        '</p>' +
        '</div>' +
        '</div>';
      return { html: popUp, borderColor: regionColor };
    }
  }

  function getCountrySidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var sideBar =
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.icourl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h3>' +
        feature.properties.name +
        '</h3>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.desc +
        '</p>';
      return sideBar;
    }
  }

  function getEmpireSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.empireIcoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h3 class="main-title">' +
        feature.properties.empire +
        '</h3>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.empireDesc +
        '</p>';
      return sideBar;
    }
  }

  function getRegionSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.regionIcoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<h3 class="main-title">' +
        feature.properties.region +
        '</h3>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.regionDesc +
        '</p>';
      return sideBar;
    }
  }

  function getSubRegionSidebarHtml(feature) {
    if (feature.properties && feature.properties.name) {
      var regionColor = setRegionColor(feature);
      var sideBar =
        '<div class="overlay-content">' +
        '<img class="overlay-image" src="' +
        feature.properties.icoUrl +
        '"/>' +
        '<div class="overlay-text">' +
        '<div class="region-label">' +
        feature.properties.region +
        '</div>' +
        '<h3 class="main-title">' +
        feature.properties.name +
        '</h3>' +
        '</div>' +
        '</div>' +
        '<p class="overlay-text">' +
        feature.properties.desc +
        '</p>';
      return sideBar;
    }
  }

  function getCountryMask(name) {
    return {
      id: 'countries-highlighted',
      type: 'fill',
      source: 'countries',
      'source-layer': 'country_boundaries',
      paint: {
        'fill-outline-color': '#6c757d',
        'fill-color': '#6c757d',
        'fill-opacity': 0.6
      },
      filter: ['!=', 'name_en', name]
    };
  }

  function setRegionColor(feature) {
    let borderColor;
    const region = feature.properties.region;
    switch (region) {
      case 'baltic':
        borderColor = 'rgb(10, 147, 150)';
        break;
      case 'denmark':
        borderColor = 'rgb(155, 34, 38)';
        break;
      case 'brandenburg':
        borderColor = 'rgb(202, 103, 2)';
        break;
      case 'saxony':
        borderColor = 'rgb(0, 95, 115)';
        break;
      case 'hessen-nassau':
        borderColor = 'rgb(0, 18, 25)';
        break;
      case 'franconia':
        borderColor = 'rgb(174, 32, 18)';
        break;
      case 'bavaria':
        borderColor = 'rgb(0, 18, 26)';
        break;
      case 'swabia':
        borderColor = 'rgb(233, 216, 166)';
        break;
      case 'lorraine':
        borderColor = 'rgb(240, 156, 0)';
        break;
      case 'rhine-maas':
        borderColor = 'rgb(85, 23, 17)';
        break;
      case 'upper-rhine':
        borderColor = 'rgb(148, 210, 189)';
        break;
      case 'westphalia':
        borderColor = 'rgb(187, 62, 3)';
        break;
      case 'the-lowlands':
        borderColor = 'rgb(41, 82, 117)';
        break;
      default:
        borderColor = 'rgb(10, 147, 150)'; // default green instead of white
    }
    return borderColor;
  }

  // Mobile sidebar close functionality
  function closeMobileSidebar() {
    const overlay = document.getElementById('map-overlay');
    if (overlay) {
      overlay.classList.remove('visible');
    }
  }

  // Helper function to apply region color to popup
  function applyRegionColorToPopup(popup, borderColor) {
    if (borderColor) {
      setTimeout(() => {
        const popupElement = popup.getElement();
        if (popupElement) {
          const popupContent = popupElement.querySelector('.popupgl');
          if (popupContent) {
            popupContent.style.borderColor = borderColor;
            popupContent.classList.add('region-colored');
          }
        }
      }, 10);
    }
  }

  function goToEmpire(feature, layer) {
    if (feature.properties && feature.properties.name) {
      window.open(feature.properties.empireUrl);
    }
  }

  function goToRegion(feature, layer) {
    if (feature.properties && feature.properties.name) {
      window.open(feature.properties.regionUrl);
    }
  }

  function goTo(feature, layer) {
    if (feature.properties && feature.properties.name) {
      window.open(feature.properties.url);
    }
  }

  // Location configuration object
  const locationConfig = {
    // Countries
    'germany': {
      mobile: { center: [10.1, 51.1], zoom: 4.25 },
      desktop: { center: [9.3, 50.6], zoom: 5.2 }
    },
    'bulgaria': {
      mobile: { center: [25.5, 42.6], zoom: 5.5 },
      desktop: { center: [25, 42.6], zoom: 6.5 }
    },
    'north-macedonia': {
      mobile: { center: [21, 40.8], zoom: 6.5 },
      desktop: { center: [21.2, 41.3], zoom: 7.5 }
    },
    'denmark': {
      mobile: { center: [11.5, 56], zoom: 5 },
      desktop: { center: [10.5, 55.5], zoom: 6.2 }
    },
    
    // Historical Regions
    'baltic': {
      mobile: { center: [11.2, 54.5], zoom: 5 },
      desktop: { center: [11.2, 53.3], zoom: 6.2 }
    },
    'brandenburg': {
      mobile: { center: [12.7, 52.7], zoom: 6 },
      desktop: { center: [12.7, 52.3], zoom: 7 }
    },
    'saxony': {
      mobile: { center: [12.3, 52], zoom: 5 },
      desktop: { center: [12.3, 52], zoom: 6.5 }
    },
    'hessen-nassau': {
      mobile: { center: [8.7, 50.8], zoom: 6 },
      desktop: { center: [8.7, 50.3], zoom: 7.2 }
    },
    'franconia': {
      mobile: { center: [10.6, 49.9], zoom: 6 },
      desktop: { center: [10.6, 49.6], zoom: 7 }
    },
    'bavaria': {
      mobile: { center: [12, 48.7], zoom: 6 },
      desktop: { center: [12, 48.7], zoom: 7 }
    },
    'swabia': {
      mobile: { center: [9.5, 48.3], zoom: 6 },
      desktop: { center: [9.5, 48], zoom: 7 }
    },
    'lorraine': {
      mobile: { center: [6.2, 49.1], zoom: 6 },
      desktop: { center: [6.5, 49.1], zoom: 7 }
    },
    'upper-rhine': {
      mobile: { center: [7.8, 49.1], zoom: 6 },
      desktop: { center: [7.8, 49.1], zoom: 6.6 }
    },
    'rhine-maas': {
      mobile: { center: [6, 50.9], zoom: 6 },
      desktop: { center: [6, 50.7], zoom: 7 }
    },
    'westphalia': {
      mobile: { center: [8.2, 52.4], zoom: 6 },
      desktop: { center: [8.2, 52.4], zoom: 6.7 }
    },
    'the-lowlands': {
      mobile: { center: [5.3, 52], zoom: 5 },
      desktop: { center: [5.3, 51.5], zoom: 6.2 }
    },
    'exploring-europe/frisia/': {
      mobile: { center: [7.2, 52.7], zoom: 6 },
      desktop: { center: [7.2, 52.7], zoom: 7 }
    },
    'the-royal-lowlands': {
      mobile: { center: [2.7, 50.3], zoom: 6 },
      desktop: { center: [2.7, 50.3], zoom: 7.2 }
    },
    'tuscany': {
      mobile: { center: [11.4, 43.4], zoom: 6 },
      desktop: { center: [11.1, 43.1], zoom: 7.4 }
    },
    'ile-de-france': {
      mobile: { center: [2.7, 49], zoom: 8 },
      desktop: { center: [2.7, 48.7], zoom: 7.4 }
    },
    'thracia-region': {
      mobile: { center: [25.5, 41.6], zoom: 6 },
      desktop: { center: [25.5, 41.6], zoom: 7 }
    },
    'shopluk-region': {
      mobile: { center: [23.1, 42.3], zoom: 6.5 },
      desktop: { center: [23.1, 42.3], zoom: 7 }
    },
    'macedonia-region': {
      mobile: { center: [22, 41], zoom: 6.5 },
      desktop: { center: [22, 41], zoom: 7 }
    },
    'danube-region': {
      mobile: { center: [26.3, 44], zoom: 5 },
      desktop: { center: [26.3, 44], zoom: 6.5 }
    },
    
    // Empires
    'kalmar-union': {
      mobile: { center: [18, 62.4], zoom: 4 },
      desktop: { center: [18, 62.4], zoom: 5 }
    },
    'holy-roman-empire': {
      mobile: { center: [11.3, 50], zoom: 5 },
      desktop: { center: [11.3, 50], zoom: 5.5 }
    },
    'kingdom-of-france': {
      mobile: { center: [2.5, 48], zoom: 5 },
      desktop: { center: [2.5, 48], zoom: 5.5 }
    },
    'ottoman-empire': {
      mobile: { center: [29, 41], zoom: 5 },
      desktop: { center: [29, 41], zoom: 5.5 }
    }
  };

  // Function to apply location configuration
  function applyLocationConfig(map, currentLocation, isMobile) {
    const viewType = isMobile ? 'mobile' : 'desktop';
    
    // Find matching location configuration
    for (const [locationKey, config] of Object.entries(locationConfig)) {
      if (currentLocation.includes(locationKey)) {
        const viewConfig = config[viewType];
        if (viewConfig) {
          map.setCenter(viewConfig.center);
          map.setZoom(viewConfig.zoom);
          
          return; // Exit after first match
        }
      }
    }
  }

  // Mobile View
  if (window.innerWidth <= 991) {
    mapboxgl.accessToken =
      'pk.eyJ1IjoiamNidW5jaDMiLCJhIjoiY2t6NzM0em9uMGlvbzMwbWdkbmR5N2loaCJ9.eKquRAbhpJDDshFFKtd9Yw';

    var currentLocation = window.location.href;
    var mobileMapLayer = 'mapbox://styles/jcbunch3/clkch6f0s001901ny45c487ne';

    var countryMap =
      currentLocation.includes('exploring-europe-by-country') &&
      !currentLocation.includes('germany') &&
      !currentLocation.includes('denmark') &&
      !currentLocation.includes('north-macedonia') &&
      !currentLocation.includes('bulgaria');

    if (countryMap) {
      var mobileMapLayer = 'mapbox://styles/jcbunch3/cljq7s8l500yu01p54jix6dqz';
    }

    const map = new mapboxgl.Map({
      container: 'map', // HTML container ID
      style: mobileMapLayer, // style URL
      center: [8.8, 52.6], // starting position as [lng, lat]
      zoom: 4
    });

    map.addControl(new mapboxgl.FullscreenControl(), 'bottom-left');
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    
    // Apply location-specific configuration
    applyLocationConfig(map, currentLocation, true);

    const overlay = document.getElementById('map-overlay');

    const popup = new mapboxgl.Popup({
      closeButton: false,
      className: 'popupgl',
      closeOnClick: true
    });

    if (!countryMap) {
      map.on('load', () => {
        const canvas = map.getCanvasContainer();

        map.addSource('regions', {
          type: 'vector',
          url: 'mapbox://jcbunch3.ckz73840i06b520t0qegud162-2862c'
        });

        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://mapbox.country-boundaries-v1'
        });

        if (currentLocation.includes('exploring-europe-by-country/germany')) {
          map.addLayer(getCountryMask('Germany'));
        }
        if (currentLocation.includes('exploring-europe-by-country/bulgaria')) {
          map.addLayer(getCountryMask('Bulgaria'));
        }
        if (currentLocation.includes('exploring-europe-by-country/north-macedonia')) {
          map.addLayer(getCountryMask('North Macedonia'));
        }
        if (currentLocation.includes('exploring-europe-by-country/denmark')) {
          map.addLayer(getCountryMask('Denmark'));
        }

        map.addLayer({
          id: 'regions',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': 'rgba(0,0,0,0)',
            'fill-color': 'rgba(0,0,0,0)'
          }
        });

        map.addLayer({
          id: 'empires-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'empire', '']
        });

        map.addLayer({
          id: 'regions-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'region', '']
        });

        map.addLayer({
          id: 'subregions-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'name', '']
        });

        function openRegionURL(e, feature) {
          window.open(feature.properties.regionUrl);
        }
        function openSubRegionURL(e, feature) {
          window.open(feature.properties.url);
        }
        function openEmpireURL(e, feature) {
          window.open(feature.properties.empireUrl);
        }

        function mousePos(e) {
          const rect = canvas.getBoundingClientRect();
          return new mapboxgl.Point(
            e.clientX - rect.left - canvas.clientLeft,
            e.clientY - rect.top - canvas.clientTop
          );
        }

        let start = mapboxgl.Point;

        map.on('click', 'regions', (e) => {
          if (start != mousePos(e)) {
            // Use the first found feature.
            const feature = e.features[0];
            let popupContent = '';
            let sideBarContent = '';
            if (map.getZoom() < 4) {
              map.setFilter('empires-highlighted', ['in', 'empire', feature.properties.empire]);
              popupContent = getMobileEmpirePopupHtml(feature);
              sideBarContent = getMobileEmpireSidebarHtml(feature);
            } else if (map.getZoom() <= 5 && map.getZoom() >= 4) {
              map.setFilter('regions-highlighted', ['in', 'region', feature.properties.region]);
              popupContent = getMobileRegionPopupHtml(feature);
              sideBarContent = getMobileRegionSidebarHtml(feature);
            } else {
              map.setFilter('subregions-highlighted', ['in', 'name', feature.properties.name]);
              popupContent = getMobileSubRegionPopupHtml(feature);
              sideBarContent = getMobileSubRegionSidebarHtml(feature);
            }

            // Render found features in an overlay.
            overlay.innerHTML = sideBarContent;
            // overlay.style.display = 'block';
						overlay.classList.add('visible');
            // Display a popup with the name of the county.
            popup.setLngLat(e.lngLat).setHTML(popupContent).setMaxWidth('none').addTo(map);
            start = mousePos(e);
          }
        });

        map.on('zoomstart', function () {
          removeFilters(map);
          popup.remove();
          closeMobileSidebar();
        });

        map.on('mousedown', function () {
          removeFilters(map);
          popup.remove();
          closeMobileSidebar();
        });
      });
    } else {
      map.on('load', () => {
        const canvas = map.getCanvasContainer();

        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://jcbunch3.cljq7ftq50rga2pt6ivoiq1ha-791oe'
        });

        map.addLayer({
          id: 'countries',
          type: 'fill',
          source: 'countries',
          'source-layer': 'Countries',
          paint: {
            'fill-outline-color': 'rgba(0,0,0,0)',
            'fill-color': 'rgba(0,0,0,0)'
          }
        });

        map.addLayer({
          id: 'countries-highlighted',
          type: 'fill',
          source: 'countries',
          'source-layer': 'Countries',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'name', '']
        });

        function openCountryURL(e, feature) {
          window.open(feature.properties.url);
        }

        function mousePos(e) {
          const rect = canvas.getBoundingClientRect();
          return new mapboxgl.Point(
            e.clientX - rect.left - canvas.clientLeft,
            e.clientY - rect.top - canvas.clientTop
          );
        }

        let start = mapboxgl.Point;

        map.on('click', 'countries', (e) => {
          // Change the cursor style as a UI indicator.
          if (start != mousePos(e)) {
            // Use the first found feature.
            const feature = e.features[0];
            let popupContent = '';
            let sideBarContent = '';
            map.setFilter('countries-highlighted', ['in', 'name', feature.properties.name]);
            popupContent = getMobileCountryPopupHtml(feature);
            sideBarContent = getMobileCountrySidebarHtml(feature);

            // Render found features in an overlay.
            overlay.innerHTML = sideBarContent;
            overlay.style.display = 'block';

            // Display a popup with the name of the county.
            popup.setLngLat(e.lngLat).setHTML(popupContent).setMaxWidth('none').addTo(map);
            start = mousePos(e);
          }
        });

        map.on('zoomstart', function () {
          removeFilters(map);
          popup.remove();
          closeMobileSidebar();
        });

        map.on('mousedown', function () {
          removeFilters(map);
          popup.remove();
          closeMobileSidebar();
        });
      });
    }

    // Normal View
  } else {
    var currentLocation = window.location.href;

    mapboxgl.accessToken =
      'pk.eyJ1IjoiamNidW5jaDMiLCJhIjoiY2t6NzM0em9uMGlvbzMwbWdkbmR5N2loaCJ9.eKquRAbhpJDDshFFKtd9Yw';

    var desktopMapLayer = 'mapbox://styles/jcbunch3/clkcgdemj001701pg5l2t71bo';

    var countryMap =
      currentLocation.includes('exploring-europe-by-country') &&
      !currentLocation.includes('germany') &&
      !currentLocation.includes('denmark') &&
      !currentLocation.includes('north-macedonia') &&
      !currentLocation.includes('bulgaria');

    if (countryMap) {
      var desktopMapLayer = 'mapbox://styles/jcbunch3/cljq7s8l500yu01p54jix6dqz';
    }

    const map = new mapboxgl.Map({
      container: 'map', // HTML container ID
      style: desktopMapLayer, // style URL
      center: [8.8, 52.4], // starting position as [lng, lat]
      zoom: 5.1
    });

    map.addControl(new mapboxgl.FullscreenControl(), 'bottom-left');
    map.addControl(new mapboxgl.NavigationControl(), 'top-right');
    
    // Apply location-specific configuration
    applyLocationConfig(map, currentLocation, false);

    const overlay = document.getElementById('map-overlay');

    const popup = new mapboxgl.Popup({
         closeButton: false,
         className: 'popupgl',
         anchor: 'bottom',
         offset: [0, -15],
         closeOnClick: false,
         maxWidth: '300px'
     });

    if (!countryMap) {
      map.on('load', () => {
        map.addSource('regions', {
          type: 'vector',
          url: 'mapbox://jcbunch3.ckz73840i06b520t0qegud162-2862c'
        });

        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://mapbox.country-boundaries-v1'
        });

        if (currentLocation.includes('exploring-europe-by-country/germany')) {
          map.addLayer(getCountryMask('Germany'));
        }
        if (currentLocation.includes('exploring-europe-by-country/bulgaria')) {
          map.addLayer(getCountryMask('Bulgaria'));
        }
        if (currentLocation.includes('exploring-europe-by-country/north-macedonia')) {
          map.addLayer(getCountryMask('North Macedonia'));
        }
        if (currentLocation.includes('exploring-europe-by-country/denmark')) {
          map.addLayer(getCountryMask('Denmark'));
        }

        map.addLayer({
          id: 'regions',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': 'rgba(0,0,0,0)',
            'fill-color': 'rgba(0,0,0,0)'
          }
        });

        map.addLayer({
          id: 'empires-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'empire', '']
        });

        map.addLayer({
          id: 'regions-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'region', '']
        });

        map.addLayer({
          id: 'subregions-highlighted',
          type: 'fill',
          source: 'regions',
          'source-layer': 'HistoricalRegions',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'name', '']
        });

        function openRegionURL(e, feature) {
          window.open(feature.properties.regionUrl);
        }
        function openSubRegionURL(e, feature) {
          window.open(feature.properties.url);
        }
        function openEmpireURL(e, feature) {
          window.open(feature.properties.empireUrl);
        }

        map.on('mousemove', 'regions', (e) => {
          // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = 'pointer';

          // Use the first found feature.
          const feature = e.features[0];
          let popupResult = null;
          let sideBarContent = '';

          if (map.getZoom() <= 5) {
            map.setFilter('empires-highlighted', ['in', 'empire', feature.properties.empire]);
            popupResult = getEmpirePopupHtml(feature);
            sideBarContent = getEmpireSidebarHtml(feature);
          } else if (map.getZoom() <= 6 && map.getZoom() > 5) {
            map.setFilter('regions-highlighted', ['in', 'region', feature.properties.region]);
            popupResult = getRegionPopupHtml(feature);
            sideBarContent = getRegionSidebarHtml(feature);
          } else {
            map.setFilter('subregions-highlighted', ['in', 'name', feature.properties.name]);
            popupResult = getSubRegionPopupHtml(feature);
            sideBarContent = getSubRegionSidebarHtml(feature);
          }

          // Render found features in an overlay.
          overlay.innerHTML = sideBarContent;
          overlay.style.display = 'block';

          // Display a popup with the name of the county.
          if (popupResult) {
            popup.setLngLat(e.lngLat).setHTML(popupResult.html).setMaxWidth('none').addTo(map);
            applyRegionColorToPopup(popup, popupResult.borderColor);
          }
        });

        map.on('click', 'regions', (e) => {
          const feature = e.features[0];
          if (map.getZoom() <= 5) {
            map.setFilter('empires-highlighted', ['in', 'empire', feature.properties.empire]);
            map.on('click', 'empires-highlighted', openEmpireURL(e, feature));
          } else if (map.getZoom() <= 6 && map.getZoom() > 5) {
            map.setFilter('regions-highlighted', ['in', 'region', feature.properties.region]);
            map.on('click', 'regions-highlighted', openRegionURL(e, feature));
          } else {
            map.setFilter('subregions-highlighted', ['in', 'name', feature.properties.name]);
            map.on('click', 'subregions-highlighted', openSubRegionURL(e, feature));
          }
        });

        map.on('mouseleave', 'regions', () => {
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });

        map.on('zoomstart', function () {
          map.getCanvas().style.cursor = '';
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });

        map.on('movestart', function () {
          map.getCanvas().style.cursor = '';
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });
      });
    } else {
      map.on('load', () => {
        map.addSource('countries', {
          type: 'vector',
          url: 'mapbox://jcbunch3.cljq7ftq50rga2pt6ivoiq1ha-791oe'
        });

        map.addLayer({
          id: 'countries',
          type: 'fill',
          source: 'countries',
          'source-layer': 'Countries',
          paint: {
            'fill-outline-color': 'rgba(0,0,0,0)',
            'fill-color': 'rgba(0,0,0,0)'
          }
        });

        map.addLayer({
          id: 'countries-highlighted',
          type: 'fill',
          source: 'countries',
          'source-layer': 'Countries',
          paint: {
            'fill-outline-color': '#6c757d',
            'fill-color': '#6c757d',
            'fill-opacity': 0.7
          },
          filter: ['in', 'name', '']
        });

        function openCountryURL(e, feature) {
          window.open(feature.properties.url);
        }

        map.on('mousemove', 'countries', (e) => {
          // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = 'pointer';

          // Use the first found feature.
          const feature = e.features[0];
          let popupResult = null;
          let sideBarContent = '';

          map.setFilter('countries-highlighted', ['in', 'name', feature.properties.name]);
          popupResult = getCountryPopupHtml(feature);
          sideBarContent = getCountrySidebarHtml(feature);

          // Render found features in an overlay.
          overlay.innerHTML = sideBarContent;
          overlay.style.display = 'block';

          // Display a popup with the name of the county.
          if (popupResult) {
            popup.setLngLat(e.lngLat).setHTML(popupResult.html).setMaxWidth('none').addTo(map);
            if (popupResult.borderColor) {
              applyRegionColorToPopup(popup, popupResult.borderColor);
            }
          }
        });

        map.on('click', 'countries', (e) => {
          const feature = e.features[0];
          map.setFilter('countries-highlighted', ['in', 'name', feature.properties.name]);
          map.on('click', 'countries', openCountryURL(e, feature));
        });

        map.on('mouseleave', 'countries', () => {
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });

        map.on('zoomstart', function () {
          map.getCanvas().style.cursor = '';
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });

        map.on('movestart', function () {
          map.getCanvas().style.cursor = '';
          removeFilters(map);
          popup.remove();
          overlay.style.display = 'none';
        });
      });
    }
  }
</script>